launch:

- arg: {name: "localization", default: "false"}
- arg: {name: "simulation", default: "false"}
- arg: {name: "qos", default: "0"}

- let: {name: "args", value: "--delete_db_on_start", if: "$(var localization)"}
- let: {name: "args", value: "", unless: "$(var localization)"}

- node:
    pkg: "rtabmap_ros"
    exec: "icp_odometry"
    name: "icp_odometry"
    namespace: "rtabmap"
    output: "log"
    remap:
    - {from: "scan", to: "/lidar/scan"}
    param:
    - {name: "use_sim_time", value: "$(var simulation)"}
    - {name: "qos", value: "$(var qos)"}
    - {name: "frame_id", value: "base"}
    - {name: "guess_frame_id", value: "odom_ekf"}
    - {name: "odom_frame_id", value: "odom"}
    - {name: "queue_size", value: 1} 
    - {name: "publish_tf", value: True}
    - {name: "scan_cloud_max_points", value: 64000}
    - {name: "wait_imu_to_init", value: False} 
    - {name: "Odom/Strategy", value: "1"}
    - {name: "Odom/ResetCountdown", value: "25"}
    - {name: "Odom/Holonomic", value: "false"}
    - {name: "Icp/Strategy", value: "1"}
    - {name: "Icp/PointToPlane", value: "true"}

- node:
    pkg: "robot_localization"
    exec: "ekf_node"
    name: "ekf_node"
    namespace: "ekf"
    output: "log"
    remap:
    - {from: "cmd_vel", to: "/control/twist"}
    param:
    - {name: "use_sim_time", value: "$(var simulation)"}
    - {name: "debug", value: True}
    - {name: "frequency", value: 30.0}
    - {name: "sensor_timeout", value: 0.3}
    - {name: "two_d_mode", value: False}
    - {name: "world_frame", value: "odom_ekf"}
    - {name: "odom_frame", value: "odom_ekf"}
    - {name: "base_link_frame", value: "base"}
    - {name: "publish_tf", value: True}
    - {name: "publish_acceleration", value: False}
    - {name: "control_timeout", value: 0.5}
    - {name: "predict_to_current_time", value: True}

    - {name: "imu0", value: "/camera/imu"}
    - {name: "imu0_queue_size", value: 1}
    - {name: "imu0_remove_gravitational_acceleration", value: False}
    - {name: "imu0_config", value: [
            False, False, False,
            False, False, False,
            False, False, False,
            False, True, False,
            False, False, False
        ]
    }

    # - {name: "process_noise_covariance", value:
    #     [
    #         0.0001,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0001,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0001,   0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0001,   0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0001,   0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0001,   0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0001,   0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0001,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0001,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0001,   0.0,    0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0001,   0.0,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0001,   0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0001,   0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0001,   0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0001
    #     ]
    # }

    # - {name: "initial_estimate_covariance", value:
    #     [
    #         0.2,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.2,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.2,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.2,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.2,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.2,   0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.2,   0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.2,   0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.2,   0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.2,    0.0,     0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.2,    0.0,     0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.2,    0.0,    0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.2,   0.0,    0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.2,   0.0,
    #         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.2
    #     ]
    # }

    - {name: "odom0", value: "/rtabmap/odom"}
    - {name: "odom0_differential", value: True}
    - {name: "odom0_queue_size", value: 1}
    - {name: "odom0_config", value: [
            True, True, False,
            False, False, False,
            False, False, False,
            False, False, False,
            False, False, False,
        ]
    }

    - {name: "use_control", value: True}
    - {name: "control_timeout", value: 0.5}
    - {name: "control_config", value: [
            True, False, False,
            False, False, True
        ]
    }
